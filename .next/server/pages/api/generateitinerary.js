"use strict";(()=>{var e={};e.id=8712,e.ids=[8712],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},8317:(e,r,t)=>{t.r(r),t.d(r,{config:()=>c,default:()=>d,routeModule:()=>u});var a={};t.r(a),t.d(a,{default:()=>handler});var i=t(1802),s=t(7153),o=t(6249),n=t(4768);let checkUserCredits=async(e,r=1)=>{try{let{data:t,error:a}=await n.O.from("user_credits").select("credits, last_credit_reset").eq("user_id",e).single();if(a){if("PGRST116"===a.code){let t=new Date,{data:a,error:i}=await n.O.from("user_credits").insert([{user_id:e,credits:30,last_credit_reset:t.toISOString()}]).select();if(i)throw i;return{hasEnoughCredits:!0,currentCredits:30,requiredCredits:r}}throw a}let i=t?.credits||0,s=t?.last_credit_reset?new Date(t.last_credit_reset):null,o=new Date,d=!s||o.getMonth()!==s.getMonth()||o.getFullYear()!==s.getFullYear();if(d){let{error:r}=await n.O.from("user_credits").update({credits:30,last_credit_reset:o.toISOString()}).eq("user_id",e);if(r)throw r;i=30}return{hasEnoughCredits:i>=r,currentCredits:i,requiredCredits:r}}catch(e){throw console.error("Error checking user credits:",e),e}},deductCredits=async(e,r=1)=>{try{let{hasEnoughCredits:t,currentCredits:a}=await checkUserCredits(e,r);if(!t)throw Error("Not enough credits");let{data:i,error:s}=await n.O.from("user_credits").update({credits:a-r}).eq("user_id",e).select();if(s)throw s;return{success:!0,newCreditBalance:a-r,data:i}}catch(e){throw console.error("Error deducting user credits:",e),e}};async function handler(e,r){if("POST"!==e.method)return r.status(405).json({error:"Method not allowed"});let{data:{session:t},error:a}=await n.O.auth.getSession();if(a||!t)return console.error("Authentication error:",a),r.status(401).json({error:"Not authenticated. Please try again"});try{let{destination:a,startDate:i,endDate:s,budget:o,interests:n,groupType:d,groupCount:c}=e.body;if(!a)return r.status(400).json({error:"Destination is required"});let u=await checkUserCredits(t.user.id,1);if(!u.hasEnoughCredits)return r.status(403).json({error:"Not enough credits to generate itinerary",currentCredits:u.currentCredits});let l=`Create a detailed travel itinerary for a trip to ${a}.
      Trip dates: ${i?new Date(i).toLocaleDateString():"Flexible"} to ${s?new Date(s).toLocaleDateString():"Flexible"}
      Budget: ${o||"Moderate"}
      Group: ${c||1} ${d||"people"}
      Interests: ${n?Array.isArray(n)?n.join(", "):n:"General sightseeing"}
      
      Include daily activities, restaurant recommendations, and accommodation suggestions.
      Format the response with clear headings for each day and sections for activities, dining, and accommodation.
      Also include a section with estimated budget breakdown.`,g="";{let e=process.env.NEXT_PUBLIC_GEMINI_API_KEY||process.env.GEMINI_API_KEY;if(!e)return r.status(500).json({error:"API key not configured"});let t=await fetch("https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent",{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":e},body:JSON.stringify({contents:[{parts:[{text:l}]}],generationConfig:{temperature:.7,maxOutputTokens:8192}})});if(!t.ok){let e=await t.json();throw console.error("AI API error:",e),Error(`AI API error: ${e.error?.message||"Unknown error"}`)}let a=await t.json();if(a.candidates&&a.candidates[0]?.content?.parts)g=a.candidates[0].content.parts[0].text;else throw Error("Unexpected response format from AI API")}let h=`# TRIP TO ${a.toUpperCase()} - CUSTOM ITINERARY

${g}`,p=await deductCredits(t.user.id,1);return r.status(200).json({itinerary:h,creditsRemaining:p.newCreditBalance})}catch(e){return console.error("Error generating itinerary:",e),r.status(500).json({error:`Failed to generate itinerary: ${e.message}`})}}let d=(0,o.l)(a,"default"),c=(0,o.l)(a,"config"),u=new i.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/generateitinerary",pathname:"/api/generateitinerary",bundlePath:"",filename:""},userland:a})}};var r=require("../../webpack-api-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),t=r.X(0,[4222,4768],()=>__webpack_exec__(8317));module.exports=t})();