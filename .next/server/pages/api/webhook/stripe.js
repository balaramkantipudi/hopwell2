"use strict";(()=>{var e={};e.id=4072,e.ids=[4072],e.modules={4217:e=>{e.exports=require("micro")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6090:e=>{e.exports=import("stripe")},9348:(e,r,s)=>{s.a(e,async(e,t)=>{try{s.r(r),s.d(r,{config:()=>l,default:()=>d,routeModule:()=>u});var i=s(1802),a=s(7153),o=s(6249),c=s(5499),n=e([c]);c=(n.then?(await n)():n)[0];let d=(0,o.l)(c,"default"),l=(0,o.l)(c,"config"),u=new i.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/webhook/stripe",pathname:"/api/webhook/stripe",bundlePath:"",filename:""},userland:c});t()}catch(e){t(e)}})},6548:(e,r,s)=>{s.d(r,{O:()=>i});let t=require("@supabase/supabase-js"),i=(0,t.createClient)("https://qlcenpzwdvvtcnblixyp.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFsY2VucHp3ZHZ2dGNuYmxpeHlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzOTY4MTMsImV4cCI6MjA2MTk3MjgxM30.B332OjGROnVxsSKra9T_Uh6fQvVdhOH21z7731pc1Kk")},5499:(e,r,s)=>{s.a(e,async(e,t)=>{try{s.r(r),s.d(r,{config:()=>d,default:()=>handler});var i=s(6090),a=s(4217),o=s(6548),c=e([i]);i=(c.then?(await c)():c)[0];let n=new i.default(process.env.STRIPE_SECRET_KEY),d={api:{bodyParser:!1}},l={price_basic:5,price_explorer:15,price_voyager:50};async function handler(e,r){let{method:s}=e;if("POST"===s){let s,t;let i=process.env.STRIPE_WEBHOOK_SECRET,c=await (0,a.buffer)(e);if(i){let a;let o=e.headers["stripe-signature"];try{a=n.webhooks.constructEvent(c,o,i)}catch(e){return console.error(`Webhook signature verification failed. ${e.message}`),r.status(400).send()}s=a.data,t=a.type}else s=e.body.data,t=e.body.type;try{switch(t){case"checkout.session.completed":{let e=await n.checkout.sessions.retrieve(s.object.id,{expand:["line_items"]}),r=e?.customer,t=e?.client_reference_id;if(!t){console.error("No client reference ID found in session");break}let i=e?.line_items?.data;if(!i||0===i.length){console.error("No line items found in session");break}let a=i[0].price.id,c=l[a];if(c){console.log(`Adding ${c} credits to user ${t}`);let{data:s,error:i}=await o.O.from("user_credits").select("*").eq("user_id",t).single();if(i){if("PGRST116"===i.code){let{data:e,error:r}=await o.O.from("user_credits").insert([{user_id:t,credits_remaining:c,total_credits_used:0}]).select().single();if(r){console.error(`Could not create user credits: ${r.message}`);break}s=e}else{console.error(`Could not fetch user credits: ${i.message}`);break}}else{let{error:e}=await o.O.from("user_credits").update({credits_remaining:s.credits_remaining+c}).eq("user_id",t);if(e){console.error(`Could not update credits: ${e.message}`);break}}let{error:n}=await o.O.from("credit_purchases").insert([{user_id:t,stripe_customer_id:r,stripe_session_id:e.id,price_id:a,credits_purchased:c,amount_paid:e.amount_total/100,status:"completed",created_at:new Date().toISOString()}]);n&&console.error(`Error recording purchase: ${n.message}`),console.log(`Credits added successfully to user ${t}`)}}}}catch(e){console.error("stripe error: ",e.message)}}return r.status(200).send()}t()}catch(e){t(e)}})}};var r=require("../../../webpack-api-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),s=r.X(0,[4222],()=>__webpack_exec__(9348));module.exports=s})();